// ============================================================================
// ULTIMATE FIX - FIX CU·ªêI C√ôNG, GI·∫¢I QUY·∫æT T·∫§T C·∫¢
// ============================================================================

(function() {
    console.log('üöÄ ULTIMATE FIX LOADING...');
    
    // ============================================================================
    // FIX 1: T·∫ÆT T·∫§T C·∫¢ SUPABASE POLLING (G√ÇY 500 ERROR)
    // ============================================================================
    
    // T·∫Øt t·∫•t c·∫£ interval
    const originalSetInterval = window.setInterval;
    window.setInterval = function(fn, delay, ...args) {
        // Ch·∫∑n t·∫•t c·∫£ interval li√™n quan ƒë·∫øn Supabase
        const fnString = fn.toString();
        if (fnString.includes('supabase') || 
            fnString.includes('exam_rooms') || 
            fnString.includes('leaderboard') ||
            fnString.includes('refresh')) {
            console.warn('‚ö†Ô∏è Blocked interval to prevent 500 error');
            return -1;
        }
        return originalSetInterval.call(this, fn, delay, ...args);
    };
    
    console.log('‚úÖ Supabase polling blocked');
    
    // ============================================================================
    // FIX 2: FIX currentQuiz NULL - B·∫¢O V·ªÜ TUY·ªÜT ƒê·ªêI
    // ============================================================================
    
    let quizBackupGlobal = null;
    
    // ƒê·ª£i quizManager load
    const waitForQuizManager = setInterval(() => {
        if (window.quizManager) {
            clearInterval(waitForQuizManager);
            
            // Wrap currentQuiz v·ªõi getter/setter
            let _currentQuiz = window.quizManager.currentQuiz;
            
            Object.defineProperty(window.quizManager, 'currentQuiz', {
                get: function() {
                    if (!_currentQuiz && quizBackupGlobal) {
                        console.warn('‚ö†Ô∏è currentQuiz was null, restoring from backup');
                        _currentQuiz = JSON.parse(JSON.stringify(quizBackupGlobal));
                    }
                    return _currentQuiz;
                },
                set: function(value) {
                    _currentQuiz = value;
                    if (value && value.questions && value.questions.length > 0) {
                        quizBackupGlobal = JSON.parse(JSON.stringify(value));
                        localStorage.setItem('quizBackup', JSON.stringify(value));
                        console.log('‚úÖ Quiz backed up:', value.title || 'Untitled');
                    }
                },
                configurable: true
            });
            
            // Restore t·ª´ localStorage n·∫øu c√≥
            try {
                const backup = localStorage.getItem('quizBackup');
                if (backup) {
                    quizBackupGlobal = JSON.parse(backup);
                    console.log('‚úÖ Loaded quiz backup from localStorage');
                }
            } catch (e) {}
            
            console.log('‚úÖ currentQuiz protection enabled');
        }
    }, 100);
    
    // ============================================================================
    // FIX 3: FIX updateAnswerModern
    // ============================================================================
    
    const waitForUpdateAnswer = setInterval(() => {
        if (window.QuizManager && window.QuizManager.prototype.updateAnswerModern) {
            clearInterval(waitForUpdateAnswer);
            
            const original = window.QuizManager.prototype.updateAnswerModern;
            
            window.QuizManager.prototype.updateAnswerModern = function(questionIndex, selectedAnswer) {
                if (!this.currentQuiz) {
                    console.error('‚ùå currentQuiz is null in updateAnswerModern');
                    
                    // Th·ª≠ restore
                    if (quizBackupGlobal) {
                        console.log('‚úÖ Restoring from global backup');
                        this.currentQuiz = JSON.parse(JSON.stringify(quizBackupGlobal));
                    } else {
                        try {
                            const backup = localStorage.getItem('quizBackup');
                            if (backup) {
                                console.log('‚úÖ Restoring from localStorage');
                                this.currentQuiz = JSON.parse(backup);
                                quizBackupGlobal = JSON.parse(backup);
                            }
                        } catch (e) {}
                    }
                    
                    if (!this.currentQuiz) {
                        console.error('‚ùå Cannot restore currentQuiz');
                        alert('L·ªói: D·ªØ li·ªáu b√†i thi b·ªã m·∫•t. Vui l√≤ng t·∫£i l·∫°i trang!');
                        return;
                    }
                }
                
                return original.call(this, questionIndex, selectedAnswer);
            };
            
            console.log('‚úÖ updateAnswerModern fixed');
        }
    }, 100);
    
    // ============================================================================
    // FIX 4: FORCE SAVE K·∫æT QU·∫¢ KHI N·ªòP B√ÄI
    // ============================================================================
    
    const waitForSubmit = setInterval(() => {
        if (window.QuizManager && window.QuizManager.prototype.submitQuiz) {
            clearInterval(waitForSubmit);
            
            const originalSubmit = window.QuizManager.prototype.submitQuiz;
            
            window.QuizManager.prototype.submitQuiz = function() {
                console.log('üìù submitQuiz called');
                
                // Backup quiz tr∆∞·ªõc khi submit
                const quizBackup = this.currentQuiz ? JSON.parse(JSON.stringify(this.currentQuiz)) : null;
                
                // G·ªçi h√†m g·ªëc
                originalSubmit.call(this);
                
                // ƒê·ª£i 2 gi√¢y r·ªìi l∆∞u k·∫øt qu·∫£
                setTimeout(() => {
                    const quiz = quizBackup || this.currentQuiz;
                    const results = this.currentResults;
                    
                    console.log('üîç Checking if need to save...');
                    console.log('Quiz:', quiz);
                    console.log('Results:', results);
                    
                    if (quiz && quiz.isRoomQuiz && quiz.roomId && quiz.userName && results) {
                        console.log('‚úÖ Saving to leaderboard...');
                        
                        saveToLeaderboard(quiz.roomId, {
                            userName: quiz.userName,
                            score: results.score,
                            correctCount: results.correctCount,
                            totalQuestions: results.totalQuestions,
                            totalTime: results.totalTime
                        });
                    } else {
                        console.warn('‚ö†Ô∏è Not a room quiz or missing data');
                    }
                }, 2000);
            };
            
            console.log('‚úÖ submitQuiz override applied');
        }
    }, 100);
    
    // ============================================================================
    // H√ÄM L∆ØU K·∫æT QU·∫¢ - ƒê∆†N GI·∫¢N NH·∫§T C√ì TH·ªÇ
    // ============================================================================
    
    async function saveToLeaderboard(roomId, result) {
        console.log('üíæ Saving to leaderboard...');
        console.log('Room ID:', roomId);
        console.log('Result:', result);
        
        try {
            if (!window.supabaseQuizManager || !window.supabaseQuizManager.supabase) {
                throw new Error('Supabase not available');
            }
            
            const supabase = window.supabaseQuizManager.supabase;
            
            const entry = {
                userName: result.userName,
                score: result.score || 0,
                correctCount: result.correctCount || 0,
                totalQuestions: result.totalQuestions || 0,
                time: result.totalTime || 0,
                completedAt: new Date().toISOString()
            };
            
            console.log('Entry:', entry);
            
            // L·∫•y d·ªØ li·ªáu hi·ªán t·∫°i
            const { data, error: fetchError } = await supabase
                .from('exam_rooms')
                .select('leaderboard, attempts')
                .eq('id', roomId)
                .single();
            
            if (fetchError) throw fetchError;
            if (!data) throw new Error('Room not found');
            
            console.log('Current data:', data);
            
            let leaderboard = data.leaderboard || [];
            const existingIndex = leaderboard.findIndex(e => e.userName === entry.userName);
            
            if (existingIndex >= 0) {
                if (entry.score > leaderboard[existingIndex].score) {
                    leaderboard[existingIndex] = entry;
                }
            } else {
                leaderboard.push(entry);
            }
            
            const uniqueUsers = new Set(leaderboard.map(e => e.userName));
            const participants = uniqueUsers.size;
            const attempts = (data.attempts || 0) + 1;
            
            console.log('New leaderboard:', leaderboard);
            console.log('Participants:', participants);
            console.log('Attempts:', attempts);
            
            // L∆∞u v√†o database
            const { error: updateError } = await supabase
                .from('exam_rooms')
                .update({
                    leaderboard: leaderboard,
                    participants: participants,
                    attempts: attempts
                })
                .eq('id', roomId);
            
            if (updateError) throw updateError;
            
            console.log('‚úÖ SAVED SUCCESSFULLY!');
            alert('‚úÖ ƒê√£ l∆∞u k·∫øt qu·∫£!\n\nNg∆∞·ªùi t·∫°o ph√≤ng: ƒê√≥ng v√† m·ªü l·∫°i modal "Xem chi ti·∫øt" ƒë·ªÉ th·∫•y k·∫øt qu·∫£ m·ªõi.');
            
        } catch (error) {
            console.error('‚ùå Save error:', error);
            alert('L·ªói khi l∆∞u: ' + error.message);
        }
    }
    
    // ============================================================================
    // FIX 5: ƒê·∫¢M B·∫¢O QUIZ DATA KH√îNG B·ªä M·∫§T
    // ============================================================================
    
    const waitForRoomManager = setInterval(() => {
        if (window.roomManager && window.roomManager.startQuizWithUserName) {
            clearInterval(waitForRoomManager);
            
            const original = window.roomManager.startQuizWithUserName;
            
            window.roomManager.startQuizWithUserName = function(room, userName) {
                console.log('üéØ Starting quiz with user:', userName);
                
                const result = original.call(this, room, userName);
                
                // Verify sau 1 gi√¢y
                setTimeout(() => {
                    if (!window.quizManager.currentQuiz) {
                        console.error('‚ùå currentQuiz is null after start!');
                        alert('L·ªói: Kh√¥ng th·ªÉ load b√†i thi. Vui l√≤ng th·ª≠ l·∫°i!');
                        return;
                    }
                    
                    // ƒê·∫£m b·∫£o c√≥ ƒë·ªß th√¥ng tin
                    window.quizManager.currentQuiz.isRoomQuiz = true;
                    window.quizManager.currentQuiz.roomId = room.id;
                    window.quizManager.currentQuiz.userName = userName;
                    window.quizManager.currentQuiz.roomCode = room.code;
                    window.quizManager.currentQuiz.roomName = room.name;
                    
                    // Backup
                    quizBackupGlobal = JSON.parse(JSON.stringify(window.quizManager.currentQuiz));
                    localStorage.setItem('quizBackup', JSON.stringify(window.quizManager.currentQuiz));
                    
                    console.log('‚úÖ Quiz data verified and backed up');
                }, 1000);
                
                return result;
            };
            
            console.log('‚úÖ startQuizWithUserName override applied');
        }
    }, 100);
    
    // ============================================================================
    // FIX 6: T·∫ÆT AUTO-REFRESH TRONG ROOM MANAGER
    // ============================================================================
    
    setTimeout(() => {
        if (window.roomManager) {
            // T·∫Øt t·∫•t c·∫£ interval
            if (window.roomManager.leaderboardRefreshInterval) {
                clearInterval(window.roomManager.leaderboardRefreshInterval);
                window.roomManager.leaderboardRefreshInterval = null;
            }
            
            // Override c√°c h√†m refresh
            if (window.roomManager.startLeaderboardRefresh) {
                window.roomManager.startLeaderboardRefresh = function() {
                    console.log('‚ö†Ô∏è Auto-refresh is disabled');
                };
            }
            
            if (window.roomManager.refreshLeaderboard) {
                window.roomManager.refreshLeaderboard = function() {
                    console.log('‚ö†Ô∏è Auto-refresh is disabled');
                };
            }
            
            console.log('‚úÖ Room manager auto-refresh disabled');
        }
    }, 2000);
    
    console.log('üéâ ULTIMATE FIX APPLIED!');
    console.log('üìù All Supabase polling blocked');
    console.log('üìù currentQuiz protected');
    console.log('üìù Result saving guaranteed');
    
})();
